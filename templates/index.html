{% load static %}
<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NESAKO AI">
    <link rel="manifest" href="/manifest.json">
    <!-- Remove icon references until we have actual icons -->
    
    <!-- Fallback za ikone ako statiƒçki fajlovi ne rade -->
    <script>
        window.addEventListener('load', function() {
            // Proveri da li su se ikone uƒçitale
            const icons = document.querySelectorAll('link[rel*="icon"]');
            icons.forEach(icon => {
                icon.onerror = function() {
                    console.warn('Icon failed to load:', this.href);
                    // Mo≈æete dodati fallback ikonu ovde
                };
            });
        });
    </script>
    <title>NESAKO AI Asistent</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Mobile helpers moved to script section below */

        // --- Preferences sync with server ---
        async function loadPreferences() {
            try {
                const res = await fetch('/api/preferences/', { credentials: 'same-origin' });
                if (res.ok) {
                    const data = await res.json();
                    autoModulesEnabled = !!data.auto_modules_enabled;
                }
            } catch (e) { /* ignore */ }
            const toggle = document.getElementById('auto-modules-toggle');
            if (toggle) {
                toggle.checked = !!autoModulesEnabled;
            }
        }

        async function savePreferences(enabled) {
            try {
                await fetch('/api/preferences/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auto_modules_enabled: !!enabled }),
                    credentials: 'same-origin'
                });
            } catch (e) { /* ignore */ }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadPreferences();
            const toggle = document.getElementById('auto-modules-toggle');
            if (toggle) {
                toggle.addEventListener('change', (e) => {
                    autoModulesEnabled = !!e.target.checked;
                    savePreferences(autoModulesEnabled);
                });
            }
        });
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 1200px;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: #0a1a2b;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0a1a2b !important;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
{{ ... }}
        }
        
        .header-center {
            flex: 1;
            text-align: center;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .chat-stats {
            font-size: 12px;
            opacity: 0.8;
            text-align: right;
        }
        
        .hamburger-menu {
            position: relative;
            display: inline-block;
        }
        
        .hamburger-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.3s;
        }
        
        .hamburger-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .hamburger-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            min-width: 250px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .hamburger-content.show {
            display: block;
        }
        
        .hamburger-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            color: #333;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
        }
        
        .hamburger-item:hover {
            background: #f8f9fa;
        }
        
        .hamburger-item:last-child {
            border-bottom: none;
        }
        
        .history-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .history-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .history-item:hover {
            background: #f8f9fa;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-title {
            font-weight: 600;
            color: #333;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .history-preview {
            color: #666;
            font-size: 11px;
            line-height: 1.3;
        }
        
        .history-time {
            color: #999;
            font-size: 10px;
            margin-top: 4px;
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 8px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .status-indicator.working {
            background: #ffc107;
            animation: spin 1s linear infinite;
        }
        
        .status-indicator.security {
            background: #dc3545;
            animation: pulse 1s infinite;
        }
        
        .status-indicator.planning {
            background: #17a2b8;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .security-warning {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 20px;
            border-left: 5px solid #fff;
            animation: securityPulse 2s infinite;
        }
        
        @keyframes securityPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        }
        
        .plan-approval {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 20px;
            border-left: 5px solid #fff;
        }
        
        .plan-steps {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            white-space: pre-line;
        }
        
        .progress-tracker {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 20px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s infinite;
        }
        
        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }
        
        .btn-approve {
            background: #28a745;
            color: white;
        }
        
        .btn-approve:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-cancel {
            background: #dc3545;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-rollback {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-rollback:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .learning-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
        }
        
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 18px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            white-space: pre-wrap;
            position: relative;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .ai-message {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .message-meta {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 10px;
            text-align: right;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-message .message-meta {
            text-align: left;
        }
        
        .typing-animation {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
            background: #f0f0f0;
            margin: 10px 20px;
            border-radius: 15px;
        }
        
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0f0;
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        #user-input {
            width: 100%;
            min-height: 44px;
            max-height: 180px;
            padding: 14px 18px;
            border: 2px solid #e0e0f0;
            border-radius: 25px;
            font-size: 16px;
            resize: none; /* auto-grow umesto ruƒçnog resize-a */
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
            line-height: 1.45;
            overflow-y: auto; /* prika≈æi skrol tek kad preƒëe max-height */
        }
        
        #user-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .image-paste-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 25px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .image-paste-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .char-counter {
            position: absolute;
            bottom: -25px;
            right: 15px;
            font-size: 12px;
            color: #666;
            transition: color 0.3s;
        }
        
        .char-counter.warning {
            color: #ff6b35;
        }
        
        .char-counter.danger {
            color: #e74c3c;
        }
        
        .input-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        #send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        #send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .conversation-flow {
            padding: 12px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0f0;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flow-indicator {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .flow-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .flow-dot.active {
            background: #667eea;
            transform: scale(1.2);
        }
        
        .flow-dot.completed {
            background: #28a745;
        }
        
        .flow-progress {
            font-size: 11px;
            color: #999;
        }
        
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                max-width: 100%;
                border-radius: 0;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .header-left, .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            #chat-messages {
                padding: 15px;
            }
            
            .input-container {
                padding: 15px;
            }
            
            .message {
                max-width: 95%;
            }
            
            .flow-indicator {
                gap: 4px;
            }
            
            .flow-dot {
                width: 8px;
                height: 8px;
            }
            
            /* Hamburger menu adjustments for mobile */
            .hamburger-content {
                min-width: 180px;
                right: 0;
            }
            
            .hamburger-item {
                padding: 15px;
                font-size: 16px;
            }
            
            /* Adjust textarea height */
            #user-input {
                min-height: 42px !important;
                max-height: 160px !important;
                font-size: 16px;
                line-height: 1.45;
            }
        }
        
        .quick-access-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .quick-access-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .task-panel {
            position: fixed;
            top: 0;
            left: -270px;
            width: 250px;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            transition: left 0.3s ease;
            z-index: 1000;
            color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .task-panel.show {
            left: 0;
        }
        
        .task-panel-header {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .task-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .task-item:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-name {
            font-size: 14px;
            font-weight: 600;
        }
        
        .task-progress {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .task-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .task-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s infinite;
        }
        
        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="height: 70px; min-height: 70px;">
            <div class="header-content" style="height: 100%; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <h1 style="font-size: 20px; margin: 0; line-height: 70px;">ü§ñ NESAKO AI</h1>
                <div class="header-menu" style="position: relative; display: flex; align-items: center; height: 100%;">
                    <div class="hamburger-menu">
                        <button id="hamburger-menu" class="hamburger-btn" style="font-size: 24px; padding: 8px 16px; margin: 0;" onclick="toggleHamburgerMenu()">
                            ‚ò∞
                        </button>
                        <div id="hamburger-content" class="hamburger-content">
                            <button class="hamburger-item" onclick="showLessonsUI()">üìö Prika≈æi nauƒçeno</button>
                            <button class="hamburger-item" onclick="clearChat()">üóëÔ∏è Obri≈°i razgovor</button>
                            <button class="hamburger-item" onclick="exportChat()">üíæ Izvezi razgovor</button>
                            <button class="hamburger-item" onclick="openSportsBetting()">‚öΩ Sportske prognoze</button>
                            <button class="hamburger-item" onclick="showSettings()">‚öôÔ∏è Pode≈°avanja</button>
                            <button class="hamburger-item" onclick="enableSelfModification()">üîÑ Samopromena</button>
                            <button class="hamburger-item" onclick="logout()">üö™ Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="status-left">
                <span class="status-indicator" id="statusIndicator">‚óè</span>
                <span class="status-text" id="statusText">Spreman za rad</span>
            </div>
            <div class="status-right">
                <span class="learning-indicator" id="learningIndicator">üß† Uƒçim...</span>
                <span class="memory-stats" id="memoryStats">Memorija: 0 chat-ova</span>
                <span id="message-count" style="margin-left: 10px;">Poruke: 0</span>
                <span id="session-time" style="margin-left: 10px;">Vreme: 0m</span>
                <label style="margin-left: 12px; display:flex; align-items:center; gap:6px; font-size:12px; color:#333; background:#fff; padding:4px 8px; border-radius:12px; border:1px solid #e0e0f0;">
                    <input type="checkbox" id="auto-modules-toggle" />
                    Auto moduli
                </label>
            </div>
        </div>
        
        <!-- Security Warning Component -->
        <div class="security-warning" id="security-warning" style="display: none;">
            <h3>üö® SIGURNOSNO UPOZORENJE</h3>
            <div id="security-message"></div>
            <div class="action-buttons">
                <button class="action-btn btn-approve" onclick="confirmSecurity()">Da, nastavi</button>
                <button class="action-btn btn-cancel" onclick="cancelSecurity()">Otka≈æi</button>
            </div>
        </div>
        
        <!-- Plan Approval Component -->
        <div class="plan-approval" id="plan-approval" style="display: none;">
            <h3>üìã PLAN RADA</h3>
            <div class="plan-steps" id="plan-steps"></div>
            <div class="action-buttons">
                <button class="action-btn btn-approve" onclick="approvePlan()">Odobri plan</button>
                <button class="action-btn btn-cancel" onclick="rejectPlan()">Izmeni plan</button>
                <button class="action-btn btn-rollback" onclick="showRollbackOptions()">GitHub Rollback</button>
            </div>
        </div>
        
        <!-- Progress Tracker Component -->
        <div class="progress-tracker" id="progress-tracker">
            <h3>‚è≥ ZADATAK U TOKU</h3>
            <div id="task-description">Izvr≈°avam kompleksan zadatak...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div id="progress-text">0% zavr≈°eno</div>
            <div class="action-buttons">
                <button class="action-btn btn-cancel" onclick="cancelTask()">Prekini zadatak</button>
            </div>
        </div>
        
        <div id="chat-messages">
            <div class="message ai-message">
                Zdravo! Ja sam NESAKO AI - definitivni asistent sa pristupom GitHub repozitorijumima. Mogu da:
                
                üîß Analiziram i menjam kod iz va≈°ih GitHub projekata
                üíª Izvr≈°avam kod u sandbox okru≈æenju  
                üåê Pretra≈æujem web za najnovije informacije
                üìä Analiziram podatke i kreiram re≈°enja
                ‚öΩ Preuzimam sportske statistike
                
                Kako mogu da vam pomognem danas?
                <div class="message-meta">
                    <span>AI ‚Ä¢ Definitivni Asistent</span>
                    <span>Sada</span>
                </div>
            </div>
        </div>
        
        <div class="conversation-flow">
            <div class="flow-indicator">
                <span>Flow:</span>
                <div class="flow-dot active" title="Korak 1"></div>
                <div class="flow-dot" title="Korak 2"></div>
                <div class="flow-dot" title="Korak 3"></div>
                <div class="flow-dot" title="Korak 4"></div>
                <div class="flow-dot" title="Korak 5"></div>
                <div class="flow-dot" title="Korak 6"></div>
                <div class="flow-dot" title="Korak 7"></div>
                <div class="flow-dot" title="Korak 8"></div>
                <div class="flow-dot" title="Korak 9"></div>
                <div class="flow-dot" title="Korak 10"></div>
            </div>
            <div id="typing-indicator" style="display: none;">
                <div class="typing-animation">
                    AI pi≈°e
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
        
        <!-- Add history menu -->
        <div class="history-menu" id="history-menu" style="display: none;"></div>
        
        <div class="loading" id="loading">
            <div>üß† AI analizira zahtev i priprema odgovor...</div>
        </div>
        
        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    id="user-input" 
                    placeholder="Unesite va≈° zahtev... (do 50,000 karaktera)
                    
Mo≈æete koristiti:
‚Ä¢ GitHub URL za analizu koda
‚Ä¢ JSON tool pozive
‚Ä¢ Paste slike za analizu (Ctrl+V)
‚Ä¢ Shift+Enter za novi red, Enter za slanje" 
                    maxlength="50000" 
                    rows="1"
                    style="min-height: 60px;"
                ></textarea>
                <div class="image-paste-overlay" id="image-paste-overlay" style="display: none;">
                    Otpustite sliku ovde
                </div>
                <div class="char-counter" id="char-counter">0/50,000</div>
            </div>
            <div class="input-actions">
                <button id="send-btn" onclick="sendMessage()" title="Po≈°alji poruku (Enter)">
                    ‚û§
                </button>
                <button class="history-btn" onclick="checkOnWeb()" title="Istra≈æi na webu" style="background:#fff;color:#333;border:1px solid #e0e0f0;border-radius:20px;padding:6px 10px;font-size:12px;margin-top:5px;">
                    üåê Istra≈æi
                </button>
            </div>
        </div>
        
        <div class="task-panel" id="task-panel">
            <div class="task-panel-header">Aktivni zadaci</div>
            <ul class="task-list" id="task-list">
                <!-- Task items will be generated dynamically -->
            </ul>
        </div>
    </div>

    <script>
        let messageCount = 1;
        let sessionStartTime = Date.now();
        let conversationHistory = [];
        let currentFlowStep = 0;
        let chatSessions = [];
        let currentSessionId = 0;
        let isTyping = false;
        let currentChatId = `chat_${Date.now()}`;
        let learningProfile = "Novi korisnik - poƒçetak uƒçenja";
        let currentTaskId = null;
        let securityPending = false;
        // User preferences
        let autoOpenTaskPanel = false; // do not auto-open task panel
        let enableComplexTasks = false; // temporarily disable complex flow to stabilize UX
        // Preference: auto modules (synced with server session)
        let autoModulesEnabled = true;
        
        // Initialize chat sessions
        function initializeSessions() {
            chatSessions = [
                {
                    id: 0,
                    title: "Poƒçetna sesija",
                    messages: [...conversationHistory],
                    timestamp: new Date(),
                    preview: "Dobrodo≈°li u NESAKO AI..."
                }
            ];
        }

        // Istra≈æi na webu - koristi direktno web_check endpoint za pouzdanije rezultate
        async function checkOnWeb() {
            const input = document.getElementById('user-input').value.trim();
            if (!input) return alert('Unesite upit za pretragu.');
            
            // Add user message to show what we're searching for
            addMessage(`üåê Istra≈æujem pouzdane izvore za: "${input}"`, true);
            
            updateStatus('Pretra≈æujem web...', true);
            try {
                // Koristimo direktno web_check endpoint koji koristi Google pretragu
                const response = await fetch(`/web_check?q=${encodeURIComponent(input)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP gre≈°ka! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    addAIMessage(`‚ùå Gre≈°ka pri pretrazi: ${data.error}`, false);
                } else if (data.content) {
                    // Formatiraj odgovor bolje
                    let formattedResponse = `üîç **REZULTATI PRETRAGE ZA "${input}":**\n\n`;
                    formattedResponse += data.content + '\n\n';
                    formattedResponse += `üåê *Izvor: ${data.source || 'Google Search'}*\n`;
                    formattedResponse += '‚ö†Ô∏è *Molim proverite informacije na zvaniƒçnim sajtovima za najtaƒçnije podatke*';
                    
                    addAIMessage(formattedResponse, false);
                } else {
                    addAIMessage('‚ùå Nisam prona≈°ao relevantne rezultate za va≈° upit.', false);
                }
            } catch (e) {
                console.error('Web check error:', e);
                addAIMessage('‚ùå Gre≈°ka u komunikaciji sa serverom prilikom pretrage. Molim poku≈°ajte ponovo.', false);
            } finally {
                updateStatus('Spreman za rad', false);
            }
        }

        // UI za prikaz lessons_learned - poslednjih 10 najkraƒáe
        async function showLessonsUI() {
            closeHamburgerMenu();
            try {
                updateStatus('Uƒçitavam nauƒçene lekcije...', true);
                const res = await fetch('/lessons/');
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                showLessons(data);
            } catch (e) {
                console.error('Error loading lessons:', e);
                // Koristimo postojeƒáu addMessage funkciju umesto addAIMessage
                addMessage('‚ùå Gre≈°ka pri uƒçitavanju nauƒçenog. Proverite konzolu za detalje.', false);
            } finally {
                updateStatus('Spreman za rad', false);
            }
        }

        function showLessons(data) {
            if (!data || !data.lessons || data.lessons.length === 0) {
                addMessage('üìö Trenutno nema saƒçuvanih nauƒçenih lekcija.', false);
                return;
            }
        
            // Sort by time and take last 10
            const recentLessons = [...data.lessons]
                .sort((a, b) => new Date(b.time) - new Date(a.time))
                .slice(0, 10);
        
            let lessonsMessage = 'üìö **POSLEDNJIH 10 NAUƒåENIH LEKCIJA:**\n\n';
            recentLessons.forEach((lesson, index) => {
                // Extract only the most important part
                const shortText = lesson.text.length > 100 
                    ? lesson.text.substring(0, 100) + '...' 
                    : lesson.text;
                lessonsMessage += `${index + 1}. ${shortText}`;
                if (lesson.time) {
                    lessonsMessage += ` (${new Date(lesson.time).toLocaleDateString('sr-RS')})`;
                }
                lessonsMessage += '\n';
            });
        
            lessonsMessage += '\n‚ÑπÔ∏è *Sinhronizovano na svim ureƒëajima*';
        
            addMessage(lessonsMessage, false);
        }

        async function sendFeedback(lessonId, verdict) {
            try {
                const response = await fetch(`/lessons/${lessonId}/feedback/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ feedback: verdict })
                });
                
                const data = await response.json();
                if (data.status === 'ok') {
                    addAIMessage('‚úÖ Hvala na povratnoj informaciji!', false);
                } else {
                    addAIMessage('‚ùå Gre≈°ka pri slanju feedback-a: ' + (data.error || 'nepoznato'), false);
                }
            } catch (e) {
                console.error('Feedback error:', e);
                addAIMessage('‚ùå Gre≈°ka u komunikaciji sa serverom.', false);
            }
        }
        
        // Update session stats - with null checks
        function updateStats() {
            const elapsed = Math.floor((Date.now() - sessionStartTime) / 60000);
            const messageCountElement = document.getElementById('message-count');
            const sessionTimeElement = document.getElementById('session-time');
            
            if (messageCountElement) {
                messageCountElement.textContent = `Poruke: ${messageCount}`;
            }
            if (sessionTimeElement) {
                sessionTimeElement.textContent = `Vreme: ${elapsed}m`;
            }
        }
        
        // Update flow indicator
        function updateFlowIndicator() {
            const dots = document.querySelectorAll('.flow-dot');
            
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index < currentFlowStep) {
                    dot.classList.add('completed');
                } else if (index === currentFlowStep) {
                    dot.classList.add('active');
                }
            });
            
            currentFlowStep = (currentFlowStep + 1) % 10;
        }
        
        // Update status
        function updateStatus(text, isWorking = false) {
            const statusText = document.getElementById('statusText');
            const statusIndicator = document.getElementById('statusIndicator');
            
            statusText.textContent = text;
            statusIndicator.className = isWorking ? 'status-indicator working' : 'status-indicator';
        }
        
        // Auto-resize textarea
        function autoResize() {
            const textarea = document.getElementById('user-input');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }
        
        // Update character counter
        function updateCharCounter() {
            const input = document.getElementById('user-input');
            const counter = document.getElementById('char-counter');
            const length = input.value.length;
            
            counter.textContent = `${length.toLocaleString()}/50,000`;
            
            counter.className = 'char-counter';
            if (length > 45000) counter.classList.add('danger');
            else if (length > 40000) counter.classList.add('warning');
        }
        
        // Format timestamp (robust)
        function formatTime(input) {
            let d = input instanceof Date ? input : new Date(input);
            if (isNaN(d.getTime())) d = new Date();
            try {
                return d.toLocaleTimeString('sr-RS', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return `${('0'+d.getHours()).slice(-2)}:${('0'+d.getMinutes()).slice(-2)}`;
            }
        }
        
        // Toggle history menu
        function toggleHistory() {
            const menu = document.getElementById('history-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            updateHistoryMenu();
        }
        
        // Update history menu
        function updateHistoryMenu() {
            const menu = document.getElementById('history-menu');
            menu.innerHTML = '';
            
            chatSessions.slice(0, 10).forEach((session, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.onclick = () => loadHistorySession(session.id);
                
                item.innerHTML = `
                    <div class="history-title">${session.title}</div>
                    <div class="history-preview">${session.preview}</div>
                    <div class="history-time">${formatTime(session.timestamp)}</div>
                `;
                
                menu.appendChild(item);
            });
        }
        
        // Load history session
        function loadHistorySession(sessionId) {
            const session = chatSessions.find(s => s.id === sessionId);
            if (session) {
                conversationHistory = [...session.messages];
                currentSessionId = sessionId;
                
                // Reload messages
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = '';
                
                conversationHistory.forEach(msg => {
                    addMessageToDOM(msg.content, msg.isUser, msg.metadata);
                });
                
                document.getElementById('history-menu').style.display = 'none';
            }
        }
        
        // Create new session
        function createNewSession(firstMessage) {
            const newSessionId = Date.now();
            const preview = firstMessage.length > 50 ? firstMessage.substring(0, 50) + '...' : firstMessage;
            
            chatSessions.unshift({
                id: newSessionId,
                title: `Sesija ${chatSessions.length + 1}`,
                messages: [],
                timestamp: new Date(),
                preview: preview
            });
            
            currentSessionId = newSessionId;
            conversationHistory = [];
        }
        
        // CSRF Token handling
        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, 19) === 'nesako_ai_csrftoken=') {
                        cookieValue = decodeURIComponent(cookie.substring(19));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function addMessageToDOM(content, isUser = false, metadata = {}) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            const timestamp = new Date();
            
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            let metaInfo = isUser ? 'Vi' : 'AI';
            if (metadata.mode) metaInfo += ` ‚Ä¢ ${metadata.mode}`;
            if (metadata.tools_used) metaInfo += ' ‚Ä¢ Tools';
            if (metadata.context_aware) metaInfo += ' ‚Ä¢ Context';
            
            // Build inner HTML
            const metaHtml = `
                <div class="message-meta">
                    <span>${metaInfo}</span>
                    <span>${formatTime(timestamp)}</span>
                </div>`;

            // For AI messages, add a small 'Izvor' button to fetch web sources
            if (!isUser) {
                // Find the last user message content to use as query
                let lastUserContent = '';
                for (let i = conversationHistory.length - 1; i >= 0; i--) {
                    if (conversationHistory[i] && conversationHistory[i].isUser) {
                        lastUserContent = conversationHistory[i].content || '';
                        break;
                    }
                }

                const contentHtml = `<div class="message-content">${content}</div>`;
                const actionsHtml = `
                    <div class="message-actions">
                        <button class="source-btn" title="Prika≈æi izvore" ${lastUserContent ? '' : 'disabled'}>
                            üìé Izvor
                        </button>
                    </div>`;
                messageDiv.innerHTML = `${contentHtml}${actionsHtml}${metaHtml}`;

                // Wire up source button
                const btn = messageDiv.querySelector('.source-btn');
                if (btn && lastUserContent) {
                    btn.addEventListener('click', async () => {
                        await fetchAndShowSources(messageDiv, lastUserContent, btn);
                    });
                }
            } else {
                // User message: simple rendering
                messageDiv.innerHTML = `
                    ${content}
                    ${metaHtml}
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Render quick follow-up actions under the last AI message to improve chat feel
        function renderQuickActions(messageDiv, lastUserContent = '') {
            try {
                if (!messageDiv || !messageDiv.classList.contains('ai-message')) return;
                // Avoid duplicates
                if (messageDiv.querySelector('.quick-actions')) return;

                const qa = document.createElement('div');
                qa.className = 'quick-actions';
                qa.style.cssText = 'margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;';

                const actions = [
                    { label: 'Objasni jednostavnije', build: (q) => `Objasni jednostavnije: ${q}` },
                    { label: 'Daj primer', build: (q) => `Daj praktiƒçan primer za: ${q}` },
                    { label: 'Nastavi', build: (q) => `Nastavi detaljnije: ${q}` },
                    { label: 'Sa≈æmi u 3 taƒçke', build: (q) => `Sa≈æmi u tri kljuƒçne taƒçke: ${q}` }
                ];

                actions.forEach(a => {
                    const btn = document.createElement('button');
                    btn.textContent = a.label;
                    btn.className = 'qa-btn';
                    btn.style.cssText = 'background:#f3f4f6;color:#111;border:1px solid #e5e7eb;border-radius:14px;padding:6px 10px;font-size:12px;cursor:pointer;';
                    btn.addEventListener('click', () => {
                        const prompt = a.build(lastUserContent || 'prethodna tema');
                        sendFollowUp(prompt);
                    });
                    qa.appendChild(btn);
                });

                const contentDiv = messageDiv.querySelector('.message-content') || messageDiv;
                contentDiv.appendChild(qa);
            } catch (e) { /* noop */ }
        }

        // Helper to send follow-up message quickly
        function sendFollowUp(text) {
            const input = document.getElementById('user-input');
            if (!input) return;
            input.value = text;
            // trigger normal send flow
            if (typeof sendMessage === 'function') {
                sendMessage();
            }
        }

        // Fetch and append sources inline at the end of the AI message content (with clickable URLs)
async function fetchAndShowSources(messageDiv, query, btn) {
    try {
        // Avoid duplicate rendering
        if (messageDiv.querySelector('.sources-inline')) {
            const existing = messageDiv.querySelector('.sources-inline');
            existing.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            return;
        }
        if (btn) {
            btn.disabled = true;
            btn.textContent = '‚è≥ Izvori...';
        }
        const res = await fetch(`/web_check?q=${encodeURIComponent(query)}`);
        let containerHtml = '';
        if (res.ok) {
            const data = await res.json();
            const results = Array.isArray(data.results) ? data.results : [];
            if (results.length === 0) {
                containerHtml = `<div class="sources-inline" style="margin-top:8px;color:#666;font-size:13px;">Nema dostupnih izvora.</div>`;
            } else {
                // Build inline list with clickable links and short quotes
                const items = results.map((r, idx) => {
                    const safeTitle = (r.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const safeUrl = (r.url || '').replace(/"/g, '&quot;');
                    const safeSnippet = (r.snippet || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const link = safeUrl ? `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeTitle || safeUrl}</a>` : (safeTitle || 'Nepoznat izvor');
                    const quote = safeSnippet ? ` ‚Äî ‚Äú${safeSnippet}‚Äù` : '';
                    return `<li style="margin:4px 0;">${idx + 1}. ${link}${quote}</li>`;
                }).join('');
                containerHtml = `
                    <div class="sources-inline" style="margin-top:8px;border-top:1px dashed #e0e0f0;padding-top:8px;">
                        <div style="font-weight:600;color:#333;margin-bottom:6px;">Izvori</div>
                        <ul style="padding-left:18px;margin:0;">${items}</ul>
                    </div>`;
            }
        } else {
            containerHtml = `<div class="sources-inline" style="margin-top:8px;color:#c0392b;">Gre≈°ka pri uƒçitavanju izvora (HTTP ${res.status})</div>`;
        }
        // Append to the message content block so it appears as part of the same AI poruke
        const contentDiv = messageDiv.querySelector('.message-content') || messageDiv;
        contentDiv.insertAdjacentHTML('beforeend', containerHtml);
    } catch (e) {
        const contentDiv = messageDiv.querySelector('.message-content') || messageDiv;
        contentDiv.insertAdjacentHTML('beforeend', `<div class="sources-inline" style="margin-top:8px;color:#d35400;">Gre≈°ka pri uƒçitavanju izvora.</div>`);
    } finally {
        if (btn) {
            btn.textContent = 'üìé Izvor';
            btn.disabled = false;
        }
    }
}

        // Fallback function if addAIMessage is called somewhere else
        function addAIMessage(content, metadata = {}) {
            addMessage(content, false, metadata);
        }

        function addMessage(content, isUser = false, metadata = {}) {
            const timestamp = new Date();
            
            addMessageToDOM(content, isUser, metadata);
            
            // Add to conversation history
            const messageData = {
                content,
                isUser,
                timestamp,
                metadata
            };
            
            conversationHistory.push(messageData);
            
            // Update current session
            const currentSession = chatSessions.find(s => s.id === currentSessionId);
            if (currentSession) {
                currentSession.messages = [...conversationHistory];
                if (isUser && currentSession.messages.length === 1) {
                    // Update preview for first user message
                    currentSession.preview = content.length > 50 ? content.substring(0, 50) + '...' : content;
                }
            }
            
            messageCount++;
            updateStats();
            updateFlowIndicator();

            // Persist chat state to localStorage so chat is not cleared on heavy tasks or refresh
            try {
                const state = {
                    conversationHistory,
                    chatSessions,
                    currentSessionId,
                    messageCount,
                    sessionStartTime,
                    autoOpenTaskPanel,
                    enableComplexTasks
                };
                localStorage.setItem('nesako_chat_state', JSON.stringify(state));
            } catch (e) {
                console.warn('LocalStorage save failed:', e);
            }
        }

        // Simulate typing effect
        function simulateTyping(text, callback) {
            const typingIndicator = document.getElementById('typing-indicator');
            typingIndicator.style.display = 'block';
            
            let index = 0;
            const speed = Math.max(20, Math.min(100, 3000 / text.length)); // Adaptive speed
            
            const tempDiv = document.createElement('div');
            tempDiv.className = 'message ai-message';
            tempDiv.style.opacity = '0.7';
            document.getElementById('chat-messages').appendChild(tempDiv);
            
            function typeChar() {
                if (index < text.length) {
                    tempDiv.textContent = text.substring(0, index + 1) + '‚ñã';
                    index++;
                    setTimeout(typeChar, speed);
                } else {
                    tempDiv.remove();
                    typingIndicator.style.display = 'none';
                    callback();
                }
            }
            
            setTimeout(typeChar, 500);
        }

        function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message || isTyping || securityPending) return;
            
            const sendBtn = document.getElementById('send-btn');
            const loading = document.getElementById('loading');
            
            // Create new session if this is first message and we have content
            if (conversationHistory.length === 0) {
                createNewSession(message);
            }
            
            // Disable input and show loading
            input.disabled = true;
            sendBtn.disabled = true;
            loading.style.display = 'block';
            isTyping = true;
            
            updateStatus('Obraƒëujem zahtev...', true);
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            updateCharCounter();
            autoResize();
            
            // Send to API
            fetch('/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    instruction: message,
                    conversation_history: conversationHistory.slice(-20),
                    task_id: currentTaskId,
                    chat_id: currentChatId
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                handleApiResponse(data);
            })
            .catch(error => {
                loading.style.display = 'none';
                addMessage(`Gre≈°ka u komunikaciji: ${error.message}`, false, { mode: 'error' });
                updateStatus('Gre≈°ka u komunikaciji', false);
                isTyping = false;
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            });
        }

        // Security warning functions
        function showSecurityWarning(message) {
            const warningDiv = document.getElementById('security-warning');
            const messageDiv = document.getElementById('security-message');
            
            messageDiv.textContent = message;
            warningDiv.style.display = 'block';
            securityPending = true;
            
            updateStatus('ƒåeka potvrdu bezbednosti', true);
            document.getElementById('statusIndicator').className = 'status-indicator security';
        }
        
        function confirmSecurity() {
            document.getElementById('security-warning').style.display = 'none';
            securityPending = false;
            updateStatus('Nastavljam sa zadatkom...', true);
            
            // Resend original message with security confirmation
            const lastMessage = conversationHistory[conversationHistory.length - 1];
            if (lastMessage && lastMessage.isUser) {
                sendMessageWithConfirmation(lastMessage.content, 'security_confirmed');
            }
        }
        
        function cancelSecurity() {
            document.getElementById('security-warning').style.display = 'none';
            securityPending = false;
            updateStatus('Zadatak otkazan zbog bezbednosti', false);
            
            addMessage("Zadatak je otkazan zbog sigurnosnih razloga. Molim vas reformuli≈°ite zahtev.", false, { mode: 'security' });
        }
        
        // Plan approval functions
        function showPlanApproval(plan) {
            const planDiv = document.getElementById('plan-approval');
            const stepsDiv = document.getElementById('plan-steps');
            
            stepsDiv.textContent = plan;
            planDiv.style.display = 'block';
            currentPlan = plan;
            
            updateStatus('ƒåeka odobrenje plana', false);
            document.getElementById('statusIndicator').className = 'status-indicator planning';
        }
        
        function approvePlan() {
            document.getElementById('plan-approval').style.display = 'none';
            updateStatus('Izvr≈°avam plan...', true);
            
            // Start plan execution
            sendMessageWithConfirmation('da', 'plan_approved');
        }
        
        function rejectPlan() {
            document.getElementById('plan-approval').style.display = 'none';
            updateStatus('Plan odbaƒçen', false);
            
            const modification = prompt("Kako ≈æelite da modifikujem plan?");
            if (modification) {
                sendMessageWithConfirmation(`Izmeni plan: ${modification}`, 'plan_modified');
            }
        }
        
        function showRollbackOptions() {
            const repoUrl = prompt("Unesite GitHub URL repozitorijuma:");
            if (repoUrl) {
                const steps = prompt("Broj koraka nazad (default: 2):", "2");
                sendMessageWithConfirmation(`{"tool": "github_rollback", "repo_url": "${repoUrl}", "steps_back": ${steps || 2}}`, 'rollback_requested');
            }
        }
        
        // Progress tracking functions
        function showProgressTracker(taskId, description) {
            const trackerDiv = document.getElementById('progress-tracker');
            const descDiv = document.getElementById('task-description');
            
            descDiv.textContent = description || 'Izvr≈°avam kompleksan zadatak...';
            trackerDiv.style.display = 'block';
            currentTaskId = taskId;
            
            // Disable progress polling to prevent 400 errors
            // startProgressPolling();
        }
        
        function updateProgress(progress) {
            const fillDiv = document.getElementById('progress-fill');
            const textDiv = document.getElementById('progress-text');
            
            fillDiv.style.width = `${progress}%`;
            textDiv.textContent = `${progress}% zavr≈°eno`;
            
            if (progress >= 100) {
                setTimeout(() => {
                    document.getElementById('progress-tracker').style.display = 'none';
                    currentTaskId = null;
                }, 2000);
            }
        }
        
        function startProgressPolling() {
            if (!currentTaskId) return;
            
            const pollInterval = setInterval(() => {
                if (!currentTaskId) {
                    clearInterval(pollInterval);
                    return;
                }
                
                // Poll for progress
                fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: currentTaskId,
                        instruction: '',
                        conversation_history: []
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'progress') {
                        updateProgress(data.progress);
                    } else if (data.status === 'success' && data.task_completed) {
                        updateProgress(100);
                        addMessage(data.response, false, { mode: 'task_completed' });
                        clearInterval(pollInterval);
                    }
                })
                .catch(error => {
                    console.error('Progress polling error:', error);
                    clearInterval(pollInterval);
                });
            }, 2000);
        }
        
        function cancelTask() {
            if (currentTaskId) {
                currentTaskId = null;
                document.getElementById('progress-tracker').style.display = 'none';
                updateStatus('Zadatak prekinut', false);
                addMessage("Zadatak je prekinut na va≈° zahtev.", false, { mode: 'cancelled' });
            }
        }
        
        // Enhanced send message with confirmation types
        function sendMessageWithConfirmation(message, confirmationType) {
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const loading = document.getElementById('loading');
            
            input.disabled = true;
            sendBtn.disabled = true;
            loading.style.display = 'block';
            isTyping = true;
            
            updateStatus('Obraƒëujem zahtev...', true);
            
            // Send to API with confirmation
            fetch('/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    instruction: message,
                    conversation_history: conversationHistory.slice(-20),
                    confirmation_type: confirmationType,
                    task_id: currentTaskId
                })
            })
            .then(response => response.json())
            .then(data => {
                handleApiResponse(data);
            })
            .catch(error => {
                loading.style.display = 'none';
                addMessage(`Gre≈°ka u komunikaciji: ${error.message}`, false, { mode: 'error' });
                updateStatus('Gre≈°ka u komunikaciji', false);
                isTyping = false;
            })
            .finally(() => {
                input.disabled = false;
                sendBtn.disabled = false;
            });
        }
        
        // Enhanced API response handler with authentication check
        function handleApiResponse(data) {
            console.log('=== API Response received ===', data);
            
            const loading = document.getElementById('loading');
            loading.style.display = 'none';
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            
            // Handle authentication errors
            if (data.status === 'unauthorized') {
                window.location.href = '/login/';
                return;
            }
            
            if (data.status === 'security_warning') {
                showSecurityWarning(data.response);
                return;
            }
            
            if (data.status === 'plan_created') {
                // Auto-approve plans when self-modification is armed
                if (autoApprovePlans) {
                    addMessage('‚úÖ Plan automatski odobren (samopromena).', false, { mode: 'planning' });
                    approvePlan();
                    return;
                } else {
                    showPlanApproval(data.plan);
                    addMessage(data.response, false, { mode: 'planning' });
                    return;
                }
            }
            
            if (data.status === 'executing') {
                showProgressTracker(data.task_id, data.response);
                addMessage(data.response, false, { mode: 'executing' });
                return;
            }
            
            if (data.status === 'progress') {
                updateProgress(data.progress);
                return;
            }
            
            if (data && (data.status === 'success' || data.response || data.content || (data.raw && Array.isArray(data.raw.results)))) {
                let msg = data.response || data.content || '';
                    updateProgress(data.progress || 5);
                    addMessage(data.response || '‚è≥ U toku...', false, { mode: 'progress' });
                } else {
                    addMessage(data.response || 'Nema odgovora', false, {
                        mode: data.mode || 'definitivni_asistent',
{{ ... }}
                isTyping = false;
                // Re-enable input
                if (input) {
                    input.disabled = false;
                    input.value = '';
                    updateStatus('Spreman za rad', false);
                }
                isTyping = false;
                try {
                    if (isMobile()) {
                        dismissMobileKeyboard();
                    } else if (input) {
                        input.focus();
                    }
                } catch (e) { /* noop */ }
                if (sendBtn) sendBtn.disabled = false;
            }
        }
        
        // Logout function
        function logout() {
            closeHamburgerMenu();
            if (confirm('Da li ste sigurni da se ≈æelite izlogovati?')) {
                fetch('/logout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    }
                })
                .then(() => {
                    window.location.href = '/login/';
                })
                .catch(() => {
                    window.location.href = '/login/';
                });
            }
        }
        
        // Quick access function
        async function quickAccess() {
            const quickBtn = document.getElementById('quick-access-btn');
            quickBtn.innerHTML = '‚è≥ Pristupam...';
            quickBtn.disabled = true;
            
            try {
                const response = await fetch('/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'nesako',
                        password: 'nesako2024'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    quickBtn.innerHTML = '‚úÖ Uspe≈°no!';
                    setTimeout(() => {
                        quickBtn.innerHTML = 'üöÄ Brzi pristup';
                        quickBtn.disabled = false;
                    }, 2000);
                    
                    // Show success message
                    showNotification('üéâ Uspe≈°no ste se ulogovali!', 'success');
                } else {
                    quickBtn.innerHTML = '‚ùå Gre≈°ka';
                    setTimeout(() => {
                        quickBtn.innerHTML = 'üöÄ Brzi pristup';
                        quickBtn.disabled = false;
                    }, 2000);
                    
                    showNotification('‚ùå ' + data.error, 'error');
                }
            } catch (error) {
                quickBtn.innerHTML = '‚ùå Gre≈°ka';
                setTimeout(() => {
                    quickBtn.innerHTML = 'üöÄ Brzi pristup';
                    quickBtn.disabled = false;
                }, 2000);
                
                showNotification('‚ùå Gre≈°ka pri pristupu', 'error');
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        function updateLearningIndicator(profile) {
            const indicator = document.getElementById('learningIndicator');
            if (profile && profile !== "Novi korisnik - poƒçetak uƒçenja") {
                indicator.textContent = `üß† ${profile}`;
                indicator.style.color = '#4CAF50';
            } else {
                indicator.textContent = 'üß† Uƒçim preferencije...';
                indicator.style.color = '#FF9800';
            }
        }
        
        function updateMemoryStats(stats) {
            const memoryElement = document.getElementById('memoryStats');
            if (stats) {
                memoryElement.textContent = `üíæ ${stats.total_chats} chat-ova (${stats.active_today} danas)`;
                memoryElement.style.color = stats.total_chats > 0 ? '#4CAF50' : '#666';
            }
        }

        // Event listeners
        const userInput = document.getElementById('user-input');
        const imagePasteOverlay = document.getElementById('image-paste-overlay');
        
        userInput.addEventListener('input', function() {
            updateCharCounter();
            autoResize();
        });
        
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Pobolj≈°ana paste funkcionalnost za slike sa boljim feedback-om
        userInput.addEventListener('paste', function(e) {
            const clipboardData = e.clipboardData || e.originalEvent.clipboardData;
            if (!clipboardData) return;
            
            // Provera za slike
            let imageFound = false;
            for (let i = 0; i < clipboardData.items.length; i++) {
                const item = clipboardData.items[i];
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    imageFound = true;
                    
                    const blob = item.getAsFile();
                    if (blob) {
                        // Prika≈æi obave≈°tenje korisniku
                        addMessage(`üì∏ Paste-ovana slika: ${blob.name || 'screenshot'}`, true);
                        
                        // Obradi sliku
                        processImageUpload(blob);
                    }
                    break;
                }
            }
            
            if (!imageFound) {
                console.log('No image found in clipboard items:', clipboardData.items);
            }
        });

        // Handle image drag and drop
        userInput.addEventListener('dragover', function(e) {
            e.preventDefault();
            imagePasteOverlay.classList.add('visible');
        });

        userInput.addEventListener('dragleave', function() {
            imagePasteOverlay.classList.remove('visible');
        });

        userInput.addEventListener('drop', function(e) {
            e.preventDefault();
            imagePasteOverlay.classList.remove('visible');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                processImageUpload(files[0]);
            }
        });

        // Process image upload with better error handling and user feedback
        async function processImageUpload(file, dataUrl = null) {
            // Show immediate feedback
            addMessage(`üì∏ Uƒçitavam sliku: ${file.name}`, true);
            updateStatus('Analiziram sliku...', true);
            
            const formData = new FormData();
            formData.append('images', file);
            formData.append('instruction', userInput.value || 'Analiziraj ovu sliku');
            
            try {
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, response: ${errorText}`);
                }
                
                const data = await response.json();
                if (data.status === 'success') {
                    addAIMessage(data.response, false);
                    // Clear input after successful image processing
                    userInput.value = '';
                    updateCharCounter();
                    autoResize();
                } else {
                    throw new Error(data.error || 'Nepoznata gre≈°ka');
                }
            } catch (error) {
                console.error('Image upload error:', error);
                addAIMessage('‚ùå Gre≈°ka pri obradi slike: ' + error.message, false);
                
                // Dodatna poruka za korisnika
                addAIMessage('‚ÑπÔ∏è Probajte da upload-ujete sliku preko dugmeta za odabir fajla umesto paste-a.', false);
            } finally {
                updateStatus('Spreman za rad', false);
            }
        }
        
        // Toggle hamburger menu
        function toggleHamburgerMenu() {
            const hamburgerContent = document.getElementById('hamburger-content');
            if (hamburgerContent) {
                hamburgerContent.classList.toggle('show');
            }
        }
        
        // Close hamburger menu
        function closeHamburgerMenu() {
            const hamburgerContent = document.getElementById('hamburger-content');
            if (hamburgerContent) {
                hamburgerContent.classList.remove('show');
            }
        }
        
        // Close hamburger menu when clicking outside
        document.addEventListener('click', function(e) {
            try {
                const hamburgerMenu = document.querySelector('.hamburger-menu');
                const hamburgerContent = document.getElementById('hamburger-content');
                
                // Bezbedan pristup za hamburger meni
                if (hamburgerMenu && hamburgerContent) {
                    if (!hamburgerMenu.contains(e.target)) {
                        hamburgerContent.classList.remove('show');
                    }
                }
                
                // Bezbedan pristup za history meni
                const historyMenu = document.getElementById('history-menu');
                if (historyMenu) {
                    // Check if click is outside the history menu
                    if (!historyMenu.contains(e.target)) {
                        // Check if click is not on any element that might open the history menu
                        const target = e.target;
                        const isHistoryButton = target.closest('.history-btn') || 
                                               target.classList.contains('history-btn');
                        if (!isHistoryButton) {
                            historyMenu.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.warn('Click handler error:', error);
            }
        });

        // Hamburger menu functions
        function clearChat() {
            closeHamburgerMenu();
            if (confirm('Da li ste sigurni da ≈æelite da obri≈°ete razgovor?')) {
                conversationHistory = [];
                document.getElementById('chat-messages').innerHTML = '';
                messageCount = 1;
                sessionStartTime = Date.now();
                updateStats();
                addMessage('Razgovor je obrisan. Kako mogu da vam pomognem?', false);
            }
        }

        function exportChat() {
            closeHamburgerMenu();
            const chatContent = conversationHistory.map(msg => 
                `${msg.isUser ? 'KORISNIK' : 'AI'}: ${msg.content}`
            ).join('\n\n');
            
            const blob = new Blob([chatContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nesako-chat-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addMessage('üíæ Razgovor je izve≈æen!', false);
        }

        function showSettings() {
            closeHamburgerMenu();
            const settings = prompt('Pode≈°avanja:\n\n1. Auto-otvaranje task panela (trenutno: ' + autoOpenTaskPanel + ')\n2. Kompleksni taskovi (trenutno: ' + enableComplexTasks + ')\n\nUnesite broj pode≈°avanja za promenu:');
            if (settings === '1') {
                autoOpenTaskPanel = !autoOpenTaskPanel;
                addMessage('‚öôÔ∏è Auto-otvaranje task panela: ' + (autoOpenTaskPanel ? 'UKLJUƒåENO' : 'ISKLJUƒåENO'), false);
            } else if (settings === '2') {
                enableComplexTasks = !enableComplexTasks;
                addMessage('‚öôÔ∏è Kompleksni taskovi: ' + (enableComplexTasks ? 'UKLJUƒåENO' : 'ISKLJUƒåENO'), false);
            }
        }

        function openSportsBetting() {
            closeHamburgerMenu();
            addMessage('‚öΩ Sportske prognoze - Molim unesite va≈° upit za sportske prognoze (npr. "Ko je favorit u utakmici Partizan - Zvezda?")', true);
        }

        function enableSelfModification() {
            closeHamburgerMenu();
            addMessage('üîÑ Samopromena aktivirana! Sada mo≈æete tra≈æiti promene koda i izgleda.', false);
        }
        
        // Initialize - with error handling
        function initializeApp() {
            try {
                // Saƒçekaj malo da se DOM potpuno uƒçita
                setTimeout(function() {
                    // Proveri da li svi kritiƒçni elementi postoje
                    const requiredElements = [
                        'user-input', 'send-btn', 'chat-messages', 
                        'message-count', 'session-time'
                    ];
                    
                    let allElementsFound = true;
                    for (const elementId of requiredElements) {
                        if (!document.getElementById(elementId)) {
                            console.warn(`Element ${elementId} not found`);
                            allElementsFound = false;
                        }
                    }
                    
                    if (allElementsFound) {
                        if (typeof initializeSessions === 'function') {
                            initializeSessions();
                        }
                        
                        // Bezbedno a≈æuriranje statistika
                        try {
                            updateStats();
                            updateCharCounter();
                            setInterval(updateStats, 30000);
                        } catch (statsError) {
                            console.warn('Stats update error:', statsError);
                        }
                        
                        // Fokusiraj input
                        const userInput = document.getElementById('user-input');
                        if (userInput) {
                            userInput.focus();
                        }
                    } else {
                        console.error('Neki kritiƒçni elementi nisu pronaƒëeni');
                    }
                }, 100); // 100ms delay
                
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }
        
        // Initialize when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Task panel toggle
        function toggleTaskPanel() {
            const taskPanel = document.getElementById('task-panel');
            const isVisible = taskPanel.classList.toggle('show');
            
            // Adjust main container margin when panel is visible
            const container = document.querySelector('.container');
            if (isVisible) {
                container.style.marginLeft = '270px';
                container.style.width = 'calc(100% - 270px)';
            } else {
                container.style.marginLeft = '0';
                container.style.width = '100%';
            }
        }
        
        // Generate task items
        function generateTaskItems() {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            
            // Simulate tasks for demo purposes
            const tasks = [
                { id: 1, name: 'Task 1', progress: 50 },
                { id: 2, name: 'Task 2', progress: 25 },
                { id: 3, name: 'Task 3', progress: 75 },
            ];
            
            tasks.forEach(task => {
                const taskItem = document.createElement('li');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <div class="task-name">${task.name}</div>
                    <div class="task-progress">
                        <div class="task-progress-fill" style="width: ${task.progress}%"></div>
                    </div>
                `;
                
                taskList.appendChild(taskItem);
            });
        }
        
        generateTaskItems();
        
        // PWA Service Worker - enabled with better caching
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(() => console.log('ServiceWorker registration successful'))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
        
        // Task Management System
        let activeTasks = new Map();
        let taskIdCounter = 1;
        
        // Restore chat state from localStorage on load
        (function restoreChatState() {
            try {
                const raw = localStorage.getItem('nesako_chat_state');
                if (!raw) return;
                const saved = JSON.parse(raw);
                if (!saved) return;
                
                conversationHistory = Array.isArray(saved.conversationHistory) ? saved.conversationHistory : [];
                chatSessions = Array.isArray(saved.chatSessions) ? saved.chatSessions : [];
                currentSessionId = typeof saved.currentSessionId !== 'undefined' ? saved.currentSessionId : currentSessionId;
                messageCount = typeof saved.messageCount === 'number' ? saved.messageCount : messageCount;
                sessionStartTime = typeof saved.sessionStartTime === 'number' ? saved.sessionStartTime : sessionStartTime;
                
                // If nothing was saved, initialize default sessions
                if (chatSessions.length === 0) {
                    initializeSessions && initializeSessions();
                }
                
                // Re-render messages
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer && conversationHistory.length > 0) {
                    messagesContainer.innerHTML = '';
                    conversationHistory.forEach(msg => {
                        addMessageToDOM(msg.content, !!msg.isUser, msg.metadata || {});
                    });
                }
                
                // Restore preferences if present
                if (typeof saved.autoOpenTaskPanel === 'boolean') autoOpenTaskPanel = saved.autoOpenTaskPanel;
                if (typeof saved.enableComplexTasks === 'boolean') enableComplexTasks = saved.enableComplexTasks;

                // Update UI stats
                updateStats();
                updateHistoryMenu && updateHistoryMenu();
            } catch (e) {
                console.warn('LocalStorage restore failed:', e);
            }
        })();
        
        // Create new task
        function createTask(taskName, instruction) {
            const taskId = `task_${Date.now()}_${taskIdCounter++}`;
            const task = {
                id: taskId,
                name: taskName,
                instruction: instruction,
                progress: 0,
                status: 'running',
                startTime: Date.now(),
                cancelled: false
            };
            
            activeTasks.set(taskId, task);
            updateTaskPanel();
            
            // Start task execution
            executeTask(task);
            
            return taskId;
        }
        
        // Execute task with progress tracking
        async function executeTask(task) {
            if (task.cancelled) return;
            
            try {
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        instruction: task.instruction,
                        conversation_history: conversationHistory,
                        task_id: task.id
                    })
                });
                
                if (task.cancelled) return;
                
                const data = await response.json();
                console.log('Task execution response:', data);
                
                if (data.status === 'progress') {
                    task.progress = data.progress || 0;
                    updateTaskPanel();
                    
                    // Continue polling for progress
                    setTimeout(() => {
                        if (!task.cancelled && task.status === 'running') {
                            pollTaskProgress(task);
                        }
                    }, 2000);
                } else if (data.status === 'success') {
                    task.status = 'completed';
                    task.progress = 100;
                    updateTaskPanel();
                    
                    // Add result to chat
                    addMessage(data.response, false);
                    
                    // Remove completed task after 5 seconds
                    setTimeout(() => {
                        activeTasks.delete(task.id);
                        updateTaskPanel();
                    }, 5000);
                } else {
                    // Start polling immediately for complex tasks
                    setTimeout(() => {
                        if (!task.cancelled && task.status === 'running') {
                            pollTaskProgress(task);
                        }
                    }, 1000);
                }
            } catch (error) {
                if (!task.cancelled) {
                    task.status = 'error';
                    updateTaskPanel();
                    console.error('Task execution error:', error);
                }
            }
        }
        
        // Poll task progress
        async function pollTaskProgress(task) {
            if (task.cancelled || task.status !== 'running') return;
            
            console.log('Polling progress for task:', task.id);
            
            try {
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        instruction: '',
                        conversation_history: [],
                        task_id: task.id
                    })
                });
                
                if (task.cancelled) return;
                
                const data = await response.json();
                console.log('Progress polling response:', data);
                
                if (data.status === 'progress' || data.status === 'running') {
                    task.progress = data.progress || Math.min(task.progress + 5, 95);
                    updateTaskPanel();
                    
                    // Continue polling
                    setTimeout(() => pollTaskProgress(task), 2000);
                } else if (data.status === 'success' || data.task_completed) {
                    task.status = 'completed';
                    task.progress = 100;
                    updateTaskPanel();
                    
                    // Add result to chat
                    addMessage(data.response, false);
                    
                    // Remove completed task after 5 seconds
                    setTimeout(() => {
                        activeTasks.delete(task.id);
                        updateTaskPanel();
                    }, 5000);
                } else {
                    // If no specific status, continue polling with incremental progress
                    task.progress = Math.min(task.progress + 3, 90);
                    updateTaskPanel();
                    setTimeout(() => pollTaskProgress(task), 2000);
                }
            } catch (error) {
                console.error('Progress polling error:', error);
                // Continue polling even on error
                if (!task.cancelled && task.status === 'running') {
                    setTimeout(() => pollTaskProgress(task), 3000);
                }
            }
        }
        
        // Cancel task
        function cancelTask(taskId) {
            const task = activeTasks.get(taskId);
            if (task) {
                task.cancelled = true;
                task.status = 'cancelled';
                updateTaskPanel();
                
                // Remove cancelled task after 2 seconds
                setTimeout(() => {
                    activeTasks.delete(taskId);
                    updateTaskPanel();
                }, 2000);
            }
        }
        
        // Update task panel display
        function updateTaskPanel() {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            
            if (activeTasks.size === 0) {
                taskList.innerHTML = '<li style="padding: 20px; text-align: center; color: #666;">Nema aktivnih zadataka</li>';
                return;
            }
            
            activeTasks.forEach(task => {
                const taskItem = document.createElement('li');
                taskItem.className = 'task-item';
                
                let statusColor = '#28a745';
                let statusText = 'U toku';
                
                if (task.status === 'completed') {
                    statusColor = '#28a745';
                    statusText = 'Zavr≈°eno';
                } else if (task.status === 'cancelled') {
                    statusColor = '#dc3545';
                    statusText = 'Otkazano';
                } else if (task.status === 'error') {
                    statusColor = '#ffc107';
                    statusText = 'Gre≈°ka';
                }
                
                taskItem.innerHTML = `
                    <div class="task-name">${task.name}</div>
                    <div style="font-size: 12px; color: #666; margin: 2px 0;">${statusText} - ${task.progress}%</div>
                    <div class="task-progress">
                        <div class="task-progress-fill" style="width: ${task.progress}%; background: ${statusColor}"></div>
                    </div>
                    ${task.status === 'running' ? '<button onclick="cancelTask(\'' + task.id + '\')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-top: 5px; cursor: pointer;">Otka≈æi</button>' : ''}
                `;
                
                taskList.appendChild(taskItem);
            });
        }
        
        // Modified sendMessage function to handle complex tasks and self-modification
        const originalSendMessage = sendMessage;
        sendMessage = function() {
            const message = document.getElementById('user-input').value.trim();
            if (!message) return;
            
            // Check for self-modification requests
            const modificationKeywords = ['promeni kod', 'izmeni izgled', 'sampromena', 'self-modify', 'update code', 'change appearance'];
            if (modificationKeywords.some(keyword => message.toLowerCase().includes(keyword))) {
                addMessage(message, true);
                updateStatus('Izvr≈°avam samopromenu...', true);
                
                // Send special instruction for self-modification
                fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        instruction: `üöÄ SAMOPROMENA: ${message} - imam dozvolu da menjam svoj kod i izgled`,
                        conversation_history: conversationHistory,
                        allow_self_modification: true
                    })
                })
                .then(response => response.json())
                .then(data => {
                    handleApiResponse(data);
                })
                .catch(error => {
                    addAIMessage('‚ùå Gre≈°ka pri samopromeni', false);
                    updateStatus('Gre≈°ka', false);
                });
                
                return;
            }
            
            // Check if this is a complex task
            const complexKeywords = ['kreiraj', 'napravi', 'build', 'create', 'develop', 'implementiraj', 'aplikacija', 'app', 'website', 'web', 'sistem', 'database', 'api', 'backend', 'frontend', 'full stack', 'projekt'];
            const isComplexTask = complexKeywords.some(keyword => message.toLowerCase().includes(keyword));
            
            // If complex flow is disabled, route to original function
            if (isComplexTask && !enableComplexTasks) {
                return originalSendMessage();
            }

            if (isComplexTask) {
                // Add user message to chat FIRST so it stays visible and enters history
                addMessage(message, true);

                // Create task and show task panel (no auto-open by default)
                const taskName = message.length > 50 ? message.substring(0, 50) + '...' : message;
                createTask(taskName, message);
                
                if (autoOpenTaskPanel) {
                    const taskPanel = document.getElementById('task-panel');
                    if (!taskPanel.classList.contains('show')) {
                        toggleTaskPanel();
                    }
                }
                
                return;
            }
            
            // For simple tasks, use original function
            originalSendMessage();
        };
        
        // Initialize task panel
        updateTaskPanel();
    </script>
</body>
</html>
<script>
// Runtime hotfix: define flags and wire self-modification without touching existing code
window.selfModifyArmed = (typeof window.selfModifyArmed !== 'undefined') ? window.selfModifyArmed : false;
window.autoApprovePlans = (typeof window.autoApprovePlans !== 'undefined') ? window.autoApprovePlans : false;

// Safer header visibility (ensure navy applies regardless of cache)
try { var hdr = document.querySelector('.header'); if (hdr) { hdr.style.background = '#102a44'; } } catch(e) {}

// Arm self-mod from hamburger
window.enableSelfModification = function() {
  try { if (typeof closeHamburgerMenu === 'function') closeHamburgerMenu(); } catch(e) {}
  window.selfModifyArmed = true;
  window.autoApprovePlans = true;
  try { if (typeof addMessage === 'function') addMessage(' Samopromena aktivirana! Sledeƒáa poruka je INSTRUKCIJA i biƒáe automatski izvr≈°ena.', false); } catch(e) {}
};

// Override sendMessage to execute self-mod immediately when armed
(function(){
  const original = window.sendMessage;
  window.sendMessage = function(){
    const el = document.getElementById('user-input');
    const message = el ? (el.value || '').trim() : '';
    if (!message) { if (typeof original === 'function') return original(); else return; }

    if (window.selfModifyArmed) {
      try { if (typeof addMessage === 'function') addMessage(message, true); } catch(e) {}
      try { if (typeof updateStatus === 'function') updateStatus('Izvr≈°avam samopromenu...', true); } catch(e) {}
      fetch('/api/chat/', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          instruction: SAMOPROMENA: ,
          conversation_history: (window.conversationHistory||[]),
          allow_self_modification: true,
          auto_execute: true,
          confirmation_type: 'plan_autoapprove'
        })
      })
      .then(r => r.json())
      .then(d => { try { if (typeof handleApiResponse === 'function') handleApiResponse(d); } catch(e) {} })
      .catch(() => { try { if (typeof addAIMessage === 'function') addAIMessage(' Gre≈°ka pri samopromeni', false); if (typeof updateStatus === 'function') updateStatus('Gre≈°ka', false); } catch(e) {} })
      .finally(() => { window.selfModifyArmed = false; });
      return;
    }

    const mods = ['promeni kod','izmeni izgled','sampromena','samopromena','self-modify','update code','change appearance'];
    if (mods.some(k => message.toLowerCase().includes(k))) {
      try { if (typeof addMessage === 'function') addMessage(message, true); } catch(e) {}
      try { if (typeof updateStatus === 'function') updateStatus('Izvr≈°avam samopromenu...', true); } catch(e) {}
      fetch('/api/chat/', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          instruction: SAMOPROMENA: ,
          conversation_history: (window.conversationHistory||[]),
          allow_self_modification: true,
          auto_execute: true,
          confirmation_type: 'plan_autoapprove'
        })
      })
      .then(r => r.json())
      .then(d => { try { if (typeof handleApiResponse === 'function') handleApiResponse(d); } catch(e) {} })
      .catch(() => { try { if (typeof addAIMessage === 'function') addAIMessage(' Gre≈°ka pri samopromeni', false); if (typeof updateStatus === 'function') updateStatus('Gre≈°ka', false); } catch(e) {} });
      return;
    }

    if (typeof original === 'function') return original();
  };
})();
</script>
